---
title: "Redlining - All Grades"
author: "Camille Bergeron"
date: "February 2023"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warnings = FALSE, message = FALSE)


rm(list = ls())

library(tidyverse)
library(tidycensus)
library(readxl)
library(writexl)
library(knitr)
library(openxlsx)
library(janitor)
```


+ January 31, 2023: added median values 
+ February 1, 2023: combining grades A and B
+ February 2, 2023: added more variables
+ February 6, 2023: added 1940 data
+ February 10, 2023: expanded out racial "other" category, cut tenure by race different ways

# Redlining Data

Pulling some demographic / descriptive variables and categorizing based off HOLC grades for Redlining Presentation for Black History Month 2023. 


## Pulling the categorical data

The spreadsheet created by Emily to classify census tracts

```{r}
# reading in data
setwd("~/GitHub/BPDA-home/redlining")
comp <- Sys.info()[7]
proj_folder <- paste0("C:/Users/", comp, "/Box/Research/Active Projects/Black History Month_2023")

tracts <- read_xlsx(paste0(proj_folder, "/03. Data/Redlining/2020Tracts_HOLC_AllGrades.xlsx"))

# combining A and B
tracts <- tracts %>%
  mutate(new_grade = ifelse(`HOLC Grade` %in% c("A", "B"), "A/B", `HOLC Grade`), .after = `HOLC Grade`) %>%
  select(!`HOLC Grade`) %>%
  rename(`HOLC Grade` = new_grade)

# getting rid of extra column 
head(tracts) %>% kable()

```


```{r}
# adding in housing data from 1940 and 1950

housing1950 <- read_xlsx(paste0(proj_folder, "/03. Data/Redlining/population_1950_in_2020_tracts.xlsx"), sheet = "housing")

# renaming
colnames(housing1950)[2:6] <- paste0(colnames(housing1950)[2:6], "_1950")

data1940 <- read_xlsx(paste0(proj_folder, "/03. Data/Redlining/population_1940_in_2020_tracts.xlsx"))
colnames(data1940)[2:ncol(data1940)] <- paste0(colnames(data1940)[2:ncol(data1940)], "_1940")

```


## Census Data

Now to look at specific variables. 

```{r}
VARS <- tidycensus::load_variables(dataset = 'acs5', year = 2021, cache = T)

# specific variables being pulled 
vars_pop <- c("B01001_001")
vars_tenure <- c("B25003_001", "B25003_002")
vars_race <- VARS$name[grepl("^B03002", VARS$name)][1:12]
vars_poverty <- VARS$name[grepl("^B17001_", VARS$name)][c(1, 2, 31)]
vars_hhincome <- VARS$name[grepl("^B19001_", VARS$name)]
vars_value <- VARS$name[grepl("^B25075_", VARS$name)]
vars_rent <- VARS$name[grepl("^B25063_", VARS$name)]
vars_commute <- VARS$name[grepl("^B08303_", VARS$name)]
vars_agg_hhinc <- VARS$name[grepl("^B19025_", VARS$name)]
vars_educ <- VARS$name[grepl("^B15003_", VARS$name)]
vars_hhtype <- VARS$name[grepl("^B11001_", VARS$name)]

vars_tenure_race <- VARS$name[grepl("^B25003", VARS$name)]
```


```{r, include=FALSE}

# pulling the data
census_vars <- tidycensus::get_acs(geography = "tract", 
                                     variable = c(vars_pop, vars_tenure, vars_race, vars_poverty, 
                                                  vars_hhincome, vars_value, vars_rent, vars_commute, 
                                                  vars_agg_hhinc, vars_educ, vars_hhtype, vars_tenure_race),
                                     output = "wide",
                                     state = "MA",
                                     county = "Suffolk",
                                     geometry = TRUE,
                                     year = 2021,
                                     cache_table = T,
                                     show_call = TRUE) 

# joining
tracts_with_vars <- tracts %>%
  left_join(data1940 %>% rename(GEOID = tract2020), by = "GEOID") %>%
  left_join(housing1950 %>% rename(GEOID = tract2020), by = c("GEOID")) %>%
  left_join(y = census_vars %>%
              select(!ends_with("M")), by = "GEOID") 

# changing the NAs in the 1950s pop to 0 for calculatiosn later
tracts_with_vars$pop1950[is.na(tracts_with_vars$pop1950)] <- 0

# output function
output_function <- function(df) {
  write_xlsx(df, paste0(proj_folder, "/03. Data/output/", deparse(substitute(df)), ".xlsx"))
  return(df %>% kable())
}

```


### Population

**NOTE:** I replaced some of the missing 1950 population values with 0 to use the summary values, but that kind of throws off the % change (as I'm assuming some of the 2020 tracts in Boston were not "Boston" in 1950, or they weren't developed at all)

```{r}
population <- tracts_with_vars %>%
  rename(pop2021 = B01001_001E) %>%
  rename(pop1940 = totpop_1940) %>%
  group_by(`HOLC Grade`) %>%
  select(`HOLC Grade`, pop1940, pop1950, pop2021) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) %>% 
  adorn_totals() %>%
  mutate(`% Change 1940 - 2021` = (pop2021/pop1940) - 1) %>%
  mutate(`% Change 1950 - 2021` = (pop2021 / pop1950) - 1) 

output_function(population)

```

### Tenure

Housing Units: 

```{r}
tenure_units <- tracts_with_vars %>%
  rename(total_housing = B25003_001E) %>%
  rename(owner_occ = B25003_002E) %>%
  group_by(`HOLC Grade`) %>%
  select(`HOLC Grade`, totunits_1940, ownocc_1940, totunits_1950, own_occ_1950, total_housing, owner_occ) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) %>% #
  adorn_totals() %>%
  mutate(`% Change Units 1940 - 2021` = (total_housing/totunits_1940) - 1) %>%
  mutate(`% Change Units 1950 - 2021` = (total_housing/totunits_1950) - 1) %>%
  select(-c(owner_occ, own_occ_1950, ownocc_1940))


output_function(tenure_units)
```

Ownership Rates: 


```{r}

tenure_ownership <- tracts_with_vars %>%
  rename(total_housing = B25003_001E) %>%
  rename(owner_occ = B25003_002E) %>%
  group_by(`HOLC Grade`) %>%
  select(`HOLC Grade`, totunits_1940, ownocc_1940, totunits_1950, own_occ_1950, total_housing, owner_occ) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) %>% #
  adorn_totals() %>%
  mutate(`Ownership Rate 1940` = ownocc_1940 / totunits_1940) %>%
  mutate(`Ownership Rate 1950` = own_occ_1950 / totunits_1950) %>%
  mutate(`Ownership Rate 2021` = owner_occ / total_housing) %>%
  mutate(`% Change in ownership rate 1940 - 2021` = `Ownership Rate 2021` - `Ownership Rate 1940`) %>%
  mutate(`% Change in ownership rate 1950 - 2021` = `Ownership Rate 2021` - `Ownership Rate 1950`) %>%
  select(-c(owner_occ, own_occ_1950, ownocc_1940, totunits_1940, totunits_1950, total_housing))

output_function(tenure_ownership)
```


Tenure by Race: 

+ 1940 Data

_Here, ownership rate is owner-occupied units of the specified race/ethnicity over total housing units_

```{r}
tenure_1940 <- tracts_with_vars %>%
  group_by(`HOLC Grade`) %>%
  select(`HOLC Grade`, totunits_1940, ownocc_1940, ownocc_white_1940, ownocc_black_1940, ownocc_oth_nw_1940) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) %>% 
  adorn_totals() %>%
  mutate(`Ownership Rate - All` = ownocc_1940 / totunits_1940) %>%
  mutate(`White Ownership Rate` = ownocc_white_1940 / totunits_1940) %>%
  mutate(`Black Ownership Rate` = ownocc_black_1940 / totunits_1940) %>%
  mutate(`Other Non-White Ownership Rate` = (ownocc_oth_nw_1940) / totunits_1940) %>%
  select(!c(totunits_1940, ownocc_1940, ownocc_white_1940, ownocc_black_1940, ownocc_oth_nw_1940))
  

output_function(tenure_1940)
```

+ 2021 Data:

```{r}
tenure_2021 <- tracts_with_vars %>%
  group_by(`HOLC Grade`) %>%
  rename(tot_white = B25003H_001E, owner_white = B25003H_002E, 
         tot_black = B25003B_001E, owner_black = B25003B_002E, 
         tot_hisp = B25003I_001E, owner_hisp = B25003I_002E, 
         tot_units_2021 = B25003_001E) %>%
  mutate(tot_apia = B25003D_001E + B25003E_001E, 
         owner_apia = B25003D_002E + B25003E_002E, 
         tot_other = tot_units_2021 - tot_white - tot_black - tot_hisp - tot_apia, 
         owner_other = B25003_002E - owner_apia - owner_white - owner_black - owner_hisp) %>%
  select(`HOLC Grade`, tot_white, tot_black, tot_hisp, tot_apia, owner_white, owner_black, owner_hisp, owner_apia, owner_other, tot_units_2021) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) %>% 
  adorn_totals() %>%
  mutate(`White Ownership Rate` = owner_white/tot_units_2021, 
         `Black Ownership Rate` = owner_black/tot_units_2021, 
         `APIA Ownership Rate` = owner_apia/tot_units_2021, 
         `Hispanic/Latinx Ownership Rate` = owner_hisp/tot_units_2021, 
         `Other OWnership Rate` = owner_other/tot_units_2021) %>%
  select(!c(starts_with("tot_"), starts_with("owner_")))
  
output_function(tenure_2021)
```



+ 1940 Data

_Here, ownership rate is owner-occupied units of the specified race/ethnicity over total owner-occupied units units_

```{r}
tenure_owned_1940 <- tracts_with_vars %>%
  group_by(`HOLC Grade`) %>%
  select(`HOLC Grade`, ownocc_1940, ownocc_white_1940, ownocc_black_1940, ownocc_oth_nw_1940) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) %>% 
  adorn_totals() %>%
  mutate(`White Ownership Rate` = ownocc_white_1940 / ownocc_1940) %>%
  mutate(`Black Ownership Rate` = ownocc_black_1940 / ownocc_1940) %>%
  mutate(`Other Non-White Ownership Rate` = (ownocc_oth_nw_1940) / ownocc_1940) %>%
  select(!c(ownocc_1940, ownocc_white_1940, ownocc_black_1940, ownocc_oth_nw_1940))
  
output_function(tenure_owned_1940)
```


+ 2021 Data:

```{r}
tenure_owned_2021 <- tracts_with_vars %>%
  group_by(`HOLC Grade`) %>%
  rename(tot_white = B25003H_001E, owner_white = B25003H_002E, 
         tot_black = B25003B_001E, owner_black = B25003B_002E, 
         tot_hisp = B25003I_001E, owner_hisp = B25003I_002E, 
         tot_own_2021 = B25003_002E ,
         tot_units_2021 = B25003_001E) %>%
  mutate(tot_apia = B25003D_001E + B25003E_001E, 
         owner_apia = B25003D_002E + B25003E_002E, 
         tot_other = tot_units_2021 - tot_white - tot_black - tot_hisp - tot_apia, 
         owner_other = tot_own_2021 - owner_apia - owner_white - owner_black - owner_hisp) %>%
  select(`HOLC Grade`, tot_white, tot_black, tot_hisp, tot_apia, owner_white, owner_black, owner_hisp, owner_apia, owner_other, tot_own_2021) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) %>% 
  adorn_totals() %>%
  mutate(`White Ownership Rate` = owner_white/tot_own_2021, 
         `Black Ownership Rate` = owner_black/tot_own_2021, 
         `APIA Ownership Rate` = owner_apia/tot_own_2021, 
         `Hispanic/Latinx Ownership Rate` = owner_hisp/tot_own_2021, 
         `Other OWnership Rate` = owner_other/tot_own_2021) %>%
  select(!c(starts_with("tot_"), starts_with("owner_")))
  
output_function(tenure_owned_2021)
```


+ 1940 Data

_Here, ownership rate is owner-occupied units of the specified race/ethnicity over the population of that particular race/ethnicity_

```{r}
tenure_race_1940 <- tracts_with_vars %>%
  group_by(`HOLC Grade`) %>%
  select(`HOLC Grade`, ownocc_white_1940, ownocc_black_1940, ownocc_oth_nw_1940, rentocc_white_1940, rentocc_black_1940, rentocc_oth_nw_1940) %>%
  mutate(tot_white = ownocc_white_1940 + rentocc_white_1940, 
         tot_black = ownocc_black_1940 + rentocc_black_1940, 
         tot_other = ownocc_oth_nw_1940 + rentocc_oth_nw_1940) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) %>% 
  adorn_totals() %>%
  mutate(`White Ownership Rate` = ownocc_white_1940 / tot_white) %>%
  mutate(`Black Ownership Rate` = ownocc_black_1940 / tot_black) %>%
  mutate(`Other Ownership Rate` = ownocc_oth_nw_1940 / tot_other) %>%
  select(!c(starts_with("own"), ends_with("1940"), starts_with("tot")))
  
output_function(tenure_race_1940)
```


+ 2021 Data:

```{r}
tenure_race_2021 <- tracts_with_vars %>%
  group_by(`HOLC Grade`) %>%
  rename(tot_white = B25003H_001E, owner_white = B25003H_002E, 
         tot_black = B25003B_001E, owner_black = B25003B_002E, 
         tot_hisp = B25003I_001E, owner_hisp = B25003I_002E, 
         tot_own_2021 = B25003_002E ,
         tot_units_2021 = B25003_001E) %>%
  mutate(tot_apia = B25003D_001E + B25003E_001E, 
         owner_apia = B25003D_002E + B25003E_002E, 
         tot_other = tot_units_2021 - tot_white - tot_black - tot_hisp - tot_apia, 
         owner_other = tot_own_2021 - owner_apia - owner_white - owner_black - owner_hisp) %>%
  select(`HOLC Grade`, tot_white, tot_black, tot_hisp, tot_apia, tot_other, owner_white, owner_black, owner_hisp, owner_apia, owner_other, tot_own_2021) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) %>% 
  adorn_totals() %>%
  mutate(`White Ownership Rate` = owner_white/tot_white, 
         `Black Ownership Rate` = owner_black/tot_black, 
         `APIA Ownership Rate` = owner_apia/tot_apia, 
         `Hispanic/Latinx Ownership Rate` = owner_hisp/tot_hisp, 
         `Other Ownership Rate` = owner_other/tot_other) %>%
  select(!c(starts_with("tot_"), starts_with("owner_")))
  
output_function(tenure_race_2021)
```

### Race and Ethnicity

Race and Ethnicity in 5 categories, counts: 

```{r}
# replacing some names 
colnames(tracts_with_vars)[grepl("^B03002", colnames(tracts_with_vars))] <- gsub("Estimate!!Total:!!", "", VARS$label[grepl("^B03002", VARS$name)][1:12])

race <- tracts_with_vars %>%
  rename(White = `Not Hispanic or Latino:!!White alone`) %>%
  rename(Black = `Not Hispanic or Latino:!!Black or African American alone`) %>%
  mutate(APIA = `Not Hispanic or Latino:!!Asian alone` + `Not Hispanic or Latino:!!Native Hawaiian and Other Pacific Islander alone`) %>%
  rename(AIAN = `Not Hispanic or Latino:!!American Indian and Alaska Native alone`) %>%
  mutate(Other = `Not Hispanic or Latino:!!Some other race alone` + `Not Hispanic or Latino:!!Two or more races:`) %>%
  rename(`Hispanic/Latino` = `Hispanic or Latino:`) %>%
  group_by(`HOLC Grade`) %>%
  select(`HOLC Grade`, White, Black, APIA, AIAN, Other, `Hispanic/Latino`) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) %>%
  adorn_totals() 

output_function(race)
```

Race and Ethnicity in 5 categories, as a share of each HOLC grade:

```{r}
grade_shares_fxn <- function(df) {
  df_sums <- rowSums(df[, -1])
  for(i in 1:nrow(df)) {
    total <- df_sums[i]
    for(j in 2:ncol(df)){
      df[i, j] <- df[i, j] / total
    }
  }
  return(df %>% kable())
}

grade_shares_fxn(race)
```

**Race and Ethnicity Comparisons 1940 - 2021:**

NOTE: "Non-White" includes Black 

```{r}
race_1940 <- tracts_with_vars %>% 
  select(`HOLC Grade`, white_1940, nonwhite_1940, black_1940) %>%
  group_by(`HOLC Grade`) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) %>%
  adorn_totals() %>%
  left_join(race %>%
              mutate(`Non White` = Black + APIA + AIAN + Other + `Hispanic/Latino`) %>%
              select(c(`HOLC Grade`, White, `Non White`, Black)), by = "HOLC Grade") %>%
  mutate(`% Change White` = (White / white_1940) - 1) %>%
  mutate(`% Change Non White` = (`Non White` / nonwhite_1940) -1) %>%
  mutate(`% Change Black` = (Black / black_1940)-1)

output_function(race_1940)
  
```



### Poverty

```{r}
poverty <- tracts_with_vars %>%
  rename(total = B17001_001E) %>%
  rename(in_pov = B17001_002E) %>%
  rename(above_pov = B17001_031E) %>%
  group_by(`HOLC Grade`) %>%
  select(`HOLC Grade`, total, in_pov, above_pov) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) %>%
  adorn_totals() %>%
  mutate(`Poverty Rate` = in_pov / total) %>%
  select(-above_pov) 
output_function(poverty)

```


### Aggregate Hosuehold Income

```{r}
agg_hhinc <- tracts_with_vars %>%
  group_by(`HOLC Grade`) %>%
  rename(`Aggregate Housheold Income` = B19025_001E) %>%
  select(`HOLC Grade`, `Aggregate Housheold Income`) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) 

output_function(agg_hhinc)
```


### Education

```{r}
educ <- tracts_with_vars %>%
  select(`HOLC Grade`, starts_with("B15003")) %>%
  mutate(`Less than HS` = select(., B15003_002E:B15003_016E) %>% rowSums(na.rm = T)) %>%
  mutate(`HS or equiv` = select(., B15003_017E:B15003_018E) %>% rowSums(na.rm = T)) %>%
  mutate(`Some College` = select(., B15003_019E:B15003_021E) %>% rowSums(na.rm = T)) %>%
  mutate(`BA+` = select(., B15003_022E:B15003_025E) %>% rowSums(na.rm = T)) %>%
  group_by(`HOLC Grade`) %>%
  select(`HOLC Grade`, `Less than HS`:`BA+`) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) %>%
    adorn_totals() 


output_function(educ)
```

Share by HOLC grade:

```{r}
grade_shares_fxn(educ)
```

### Household Type

```{r}
hhtype <- tracts_with_vars %>%
  group_by(`HOLC Grade`) %>%
  select(`HOLC Grade`, starts_with("B11001")) %>%
  rename(Married = B11001_003E) %>%
  rename(`Male HH` = B11001_005E) %>%
  rename(`Female HH` = B11001_006E) %>%
  rename(`Non-family` = B11001_007E) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) %>%
    adorn_totals() %>%
  select(`HOLC Grade`, Married, `Male HH`, `Female HH`, `Non-family`)

output_function(hhtype)
```

Share by HOLC Grade: 

```{r}
grade_shares_fxn(hhtype)
```


### Median Values

+ Also being pulled will be household income, value, and gross rent
+ The dollar values are in 2021$

```{r, include = FALSE}
hhincome <- tracts_with_vars %>%
  group_by(`HOLC Grade`) %>%
  select(`HOLC Grade`, starts_with("B19001")) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) 

output_function(hhincome)

value <- tracts_with_vars %>%
  group_by(`HOLC Grade`) %>%
  select(`HOLC Grade`, starts_with("B25075")) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) 

output_function(value)

rent <- tracts_with_vars %>%
  group_by(`HOLC Grade`) %>%
  select(`HOLC Grade`, starts_with("B25063")) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) 

output_function(rent)

commute <- tracts_with_vars %>%
  group_by(`HOLC Grade`) %>%
  select(`HOLC Grade`, starts_with("B08303")) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) 

output_function(commute)
```

```{r}
medians <- read_xlsx(paste0(proj_folder, "/03. Data/output/medians.xlsx"), sheet = "medians")

medians$`MEDIAN VALUES (2021$)` %>% cbind(
  medians %>%
    select(!`MEDIAN VALUES (2021$)`) %>%
    mutate_all(function(x) round(as.numeric(as.character(x)), 0))) %>%
  kable()

```


## Other Data Sources

### Crime Rates

+ Looking at the crime rate per HOLC grading zones
+ The crime data comes from https://data.boston.gov/dataset/crime-incident-reports-august-2015-to-date-source-new-system
- Used the data from 2021
- dropped "NA" assigned HOLC grades, something to investigate later? 

```{r}
crime_by_tract <- read_xlsx(paste0(proj_folder, "/03. Data/input/crime_report_CT2020.xlsx"))


# joining to grade data
crimeRate <- crime_by_tract %>%
  left_join(tracts %>% rename(GEOID20 = GEOID), by = "GEOID20") %>%
  group_by(`HOLC Grade`) %>%
  summarise(`Reported Crimes` = n()) %>%
      adorn_totals() %>%
  drop_na() %>%
  cbind(population$pop2021) %>%
  rename(Population = `population$pop2021`) %>%
  mutate(`Crime Rate` = `Reported Crimes` / Population) 

output_function(crimeRate)

```


