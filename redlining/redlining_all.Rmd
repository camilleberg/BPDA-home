---
title: "Redlining - All Grades"
author: "Camille Bergeron"
date: "February 2023"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warnings = FALSE, message = FALSE)


rm(list = ls())

library(tidyverse)
library(tidycensus)
library(readxl)
library(writexl)
library(knitr)
library(openxlsx)
```


+ January 31, 2023: added median values 
+ February 1, 2023: combining grades A and B
+ February 2, 2023: added more variables

# Redlining Data

Pulling some demographic / descriptive variables and categorizing based off HOLC grades for Redlining Presentation for Black History Month 2023. 


## Pulling the categorical data

The spreadsheet created by Emily to classify census tracts

```{r}
# reading in data
setwd("~/GitHub/BPDA-home/redlining")
comp <- Sys.info()[7]
proj_folder <- paste0("C:/Users/", comp, "/Box/Research/Active Projects/Black History Month_2023")

tracts <- read_xlsx(paste0(proj_folder, "/03. Data/Redlining/2020Tracts_HOLC_AllGrades.xlsx"))

# combining A and B
tracts <- tracts %>%
  mutate(new_grade = ifelse(`HOLC Grade` %in% c("A", "B"), "A/B", `HOLC Grade`), .after = `HOLC Grade`) %>%
  select(!`HOLC Grade`) %>%
  rename(`HOLC Grade` = new_grade)

# getting rid of extra column 
head(tracts) %>% kable()

```


```{r}
# adding in housing data from 1950

housing1950 <- read_xlsx(paste0(proj_folder, "/03. Data/Redlining/population_1950_in_2020_tracts.xlsx"), sheet = "housing")

# renaming
colnames(housing1950)[2:6] <- paste0(colnames(housing1950)[2:6], "_1950")

```


## Census Data

Now to look at specific variables. 

```{r}
VARS <- tidycensus::load_variables(dataset = 'acs5', year = 2021, cache = T)

# specific variables being pulled 
vars_pop <- c("B01001_001")
vars_tenure <- c("B25003_001", "B25003_002")
vars_race <- VARS$name[grepl("^B03002", VARS$name)][1:12]
vars_poverty <- VARS$name[grepl("^B17001_", VARS$name)][c(1, 2, 31)]
vars_hhincome <- VARS$name[grepl("^B19001_", VARS$name)]
vars_value <- VARS$name[grepl("^B25075_", VARS$name)]
vars_rent <- VARS$name[grepl("^B25063_", VARS$name)]
vars_commute <- VARS$name[grepl("^B08303_", VARS$name)]
vars_agg_hhinc <- VARS$name[grepl("^B19025_", VARS$name)]
vars_educ <- VARS$name[grepl("^B15003_", VARS$name)]
vars_hhtype <- VARS$name[grepl("^B11001_", VARS$name)]
```


```{r, include=FALSE}

# pulling the data
census_vars <- tidycensus::get_acs(geography = "tract", 
                                     variable = c(vars_pop, vars_tenure, vars_race, vars_poverty, 
                                                  vars_hhincome, vars_value, vars_rent, vars_commute, 
                                                  vars_agg_hhinc, vars_educ, vars_hhtype),
                                     output = "wide",
                                     state = "MA",
                                     county = "Suffolk",
                                     geometry = TRUE,
                                     year = 2021,
                                     cache_table = T,
                                     show_call = TRUE) 

# joining
tracts_with_vars <- tracts %>%
  left_join(housing1950 %>% rename(GEOID = tract2020), by = c("GEOID")) %>%
  left_join(y = census_vars %>%
              select(!ends_with("M")), by = "GEOID") 

# changing the NAs in the 1950s pop to 0 for calculatiosn later
tracts_with_vars$pop1950[is.na(tracts_with_vars$pop1950)] <- 0

# output function
output_function <- function(df) {
  write_xlsx(df, paste0(proj_folder, "/03. Data/output/", deparse(substitute(df)), ".xlsx"))
  return(df %>% kable())
}

```


### Population

**NOTE:** I replaced some of the missing 1950 population values with 0 to use the summary values, but that kind of throws off the % change (as I'm assuming some of the 2020 tracts in Boston were not "Boston" in 1950, or they weren't developed at all)

```{r}
population <- tracts_with_vars %>%
  rename(pop2021 = B01001_001E) %>%
  group_by(`HOLC Grade`) %>%
  select(`HOLC Grade`, pop1950, pop2021) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) %>% 
  mutate(perc_pop_change = (pop2021 / pop1950) - 1) 

output_function(population)

```

### Tenure

```{r}
tenure <- tracts_with_vars %>%
  rename(total_housing = B25003_001E) %>%
  rename(owner_occ = B25003_002E) %>%
  group_by(`HOLC Grade`) %>%
  select(`HOLC Grade`, total_housing, owner_occ, totunits_1950, own_occ_1950) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) %>% #
  mutate(`Ownership Rate 1950` = own_occ_1950 / totunits_1950) %>%
  mutate(`Ownership Rate 2021` = owner_occ / total_housing) %>%
  mutate(`Change in units` = (total_housing/totunits_1950) - 1) %>%
  mutate(`Change in ownership rate` = `Ownership Rate 2021` - `Ownership Rate 1950`) %>%
  select(-c(owner_occ, own_occ_1950))

output_function(tenure)
```



### Race and Ethnicity

Race and Ethnicity in 5 categories, counts: 

```{r}
# replacing some names 
colnames(tracts_with_vars)[grepl("^B03002", colnames(tracts_with_vars))] <- gsub("Estimate!!Total:!!", "", VARS$label[grepl("^B03002", VARS$name)][1:12])

race <- tracts_with_vars %>%
  rename(White = `Not Hispanic or Latino:!!White alone`) %>%
  rename(Black = `Not Hispanic or Latino:!!Black or African American alone`) %>%
  mutate(APIA = `Not Hispanic or Latino:!!Asian alone` + `Not Hispanic or Latino:!!Native Hawaiian and Other Pacific Islander alone`) %>%
  rename(AIAN = `Not Hispanic or Latino:!!American Indian and Alaska Native alone`) %>%
  mutate(Other = `Not Hispanic or Latino:!!Some other race alone` + `Not Hispanic or Latino:!!Two or more races:`) %>%
  rename(`Hispanic/Latino` = `Hispanic or Latino:`) %>%
  group_by(`HOLC Grade`) %>%
  select(`HOLC Grade`, White, Black, APIA, AIAN, Other, `Hispanic/Latino`) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) 

output_function(race)
```

Race and Ethnicity in 5 categories, as a share of each HOLC grade:

```{r}
grade_shares_fxn <- function(df) {
  df_sums <- rowSums(df[, -1])
  for(i in 1:nrow(df)) {
    total <- df_sums[i]
    for(j in 2:ncol(df)){
      df[i, j] <- df[i, j] / total
    }
  }
  return(df %>% kable())
}

grade_shares_fxn(race)
```

### Poverty

```{r}
poverty <- tracts_with_vars %>%
  rename(total = B17001_001E) %>%
  rename(in_pov = B17001_002E) %>%
  rename(above_pov = B17001_031E) %>%
  group_by(`HOLC Grade`) %>%
  select(`HOLC Grade`, total, in_pov, above_pov) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) %>%
  mutate(`Poverty Rate` = in_pov / total) %>%
  select(-above_pov) 
output_function(poverty)

```


### Aggregate Hosuehold Income

```{r}
agg_hhinc <- tracts_with_vars %>%
  group_by(`HOLC Grade`) %>%
  rename(`Aggregate Housheold Income` = B19025_001E) %>%
  select(`HOLC Grade`, `Aggregate Housheold Income`) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) 

output_function(agg_hhinc)
```


### Education

```{r}
educ <- tracts_with_vars %>%
  select(`HOLC Grade`, starts_with("B15003")) %>%
  mutate(`Less than HS` = select(., B15003_002E:B15003_016E) %>% rowSums(na.rm = T)) %>%
  mutate(`HS or equiv` = select(., B15003_017E:B15003_018E) %>% rowSums(na.rm = T)) %>%
  mutate(`Some College` = select(., B15003_019E:B15003_021E) %>% rowSums(na.rm = T)) %>%
  mutate(`BA+` = select(., B15003_022E:B15003_025E) %>% rowSums(na.rm = T)) %>%
  group_by(`HOLC Grade`) %>%
  select(`HOLC Grade`, `Less than HS`:`BA+`) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) 


output_function(educ)
```

Share by HOLC grade:

```{r}
grade_shares_fxn(educ)
```

### Household Type

```{r}
hhtype <- tracts_with_vars %>%
  group_by(`HOLC Grade`) %>%
  select(`HOLC Grade`, starts_with("B11001")) %>%
  rename(Married = B11001_003E) %>%
  rename(`Male HH` = B11001_005E) %>%
  rename(`Female HH` = B11001_006E) %>%
  rename(`Non-family` = B11001_007E) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) %>%
  select(`HOLC Grade`, Married, `Male HH`, `Female HH`, `Non-family`)

output_function(hhtype)
```

Share by HOLC Grade: 

```{r}
grade_shares_fxn(hhtype)
```


### Median Values

+ Also being pulled will be household income, value, and gross rent
+ The dollar values are in 2021$

```{r, include = FALSE}
hhincome <- tracts_with_vars %>%
  group_by(`HOLC Grade`) %>%
  select(`HOLC Grade`, starts_with("B19001")) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) 

output_function(hhincome)

value <- tracts_with_vars %>%
  group_by(`HOLC Grade`) %>%
  select(`HOLC Grade`, starts_with("B25075")) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) 

output_function(value)

rent <- tracts_with_vars %>%
  group_by(`HOLC Grade`) %>%
  select(`HOLC Grade`, starts_with("B25063")) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) 

output_function(rent)

commute <- tracts_with_vars %>%
  group_by(`HOLC Grade`) %>%
  select(`HOLC Grade`, starts_with("B08303")) %>%
  summarise(across(everything(), ~ sum(., is.na(.), 0))) 

output_function(commute)
```

```{r}
medians <- read_xlsx(paste0(proj_folder, "/03. Data/output/medians.xlsx"), sheet = "medians")

medians$`MEDIAN VALUES (2021$)` %>% cbind(
  medians %>%
    select(!`MEDIAN VALUES (2021$)`) %>%
    mutate_all(function(x) round(as.numeric(as.character(x)), 0))) %>%
  kable()

```

### Household Type

```{r}

```



## Other Data Sources

### Crime Rates

+ Looking at the crime rate per HOLC grading zones
+ The crime data comes from https://data.boston.gov/dataset/crime-incident-reports-august-2015-to-date-source-new-system
- Used the data from 2021
- dropped "NA" assigned HOLC grades, something to investigate later? 

```{r}
crime_by_tract <- read_xlsx(paste0(proj_folder, "/03. Data/input/crime_report_CT2020.xlsx"))


# joining to grade data
crimeRate <- crime_by_tract %>%
  left_join(tracts %>% rename(GEOID20 = GEOID), by = "GEOID20") %>%
  group_by(`HOLC Grade`) %>%
  summarise(`Reported Crimes` = n()) %>%
  drop_na() %>%
  cbind(population$pop2021) %>%
  rename(Population = `population$pop2021`) %>%
  mutate(`Crime Rate` = `Reported Crimes` / Population)

output_function(crimeRate)

```

